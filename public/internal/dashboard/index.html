<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Dashboard | CHS Math Bowl</title>
    <link rel="stylesheet" href="../../css/main.css" type="text/css">
    <style>
      html, body {
        padding: 0;
        margin: 0;
        user-select: none;
        /*cursor: none;*/
      }
      #logocontainer {
        display: flex;
        flex-direction: row;
        align-items: center;
        width: 100%;
        justify-content: center;
        position: absolute;
        top: 20px;
      }
      #container {
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      #title {
        font-family: "Jost Thin";
        font-size: 50px;
        color: #333;
      }
      #time {
        font-family: "Jost Bold", Arial, Helvetica, sans-serif;
        color: #333;
        font-size: 100px;
        margin: 100px 0px;
        padding: 0px;
      }

      .card {
        border-radius: 8px;
        box-shadow: 0px 0px 10px 0px #ddd;
        padding: 10px;
        background-color: white;
        /*margin: 20px;
        height: 230px;
        width: 230px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: 400ms;*/
      }

      #scores-container {
        display: flex;
        flex-direction: row;
      }

      .score {
        color: #9e1c43;
        font-family: "Jost", Arial, Helvetica, sans-serif;
        font-size: 100px;
      }

      .abbrev {
        color: #333;
        font-family: "Jost Bold";
        font-size: 40px;
      }

      .card-hover > .abbrev {
        text-decoration: 5px #eee underline;
      }

      .card-clicked {
        background-color: #9e1c43 !important;
      }
      .card-clicked > .score, .card-clicked > .abbrev {
        color: white !important;
        text-decoration: none !important;
      }

      #dragon {
        height: 150px;
      }
      #home-box {
        height: 100vh;
        width: 100vw;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      h1 {
        font-family: "Jost Medium", Arial, Helvetica, sans-serif;
        color: black;
        text-transform: none;
        font-size: 40px;
        margin: 0px;
        margin-top: 10px;
      }
      h4 {
        font-family: "Jost Thin", Arial, Helvetica, sans-serif;
        color: black;
        margin: 0px;
        font-size: 20px;
        margin-bottom: 20px;
        cursor: pointer;
      }
      #matches-list {
        height: 500px;
        width: 30vw;
        overflow-y: scroll;
        scrollbar-width: none;
        padding: 10px;
        font-family: "Jost", Arial, Helvetica, sans-serif;
      }
      #matches-list::-webkit-scrollbar {
          width: 0;
          height: 0;
      }
      .round-name-card {
        font-family: "Jost Medium", Arial, Helvetica, sans-serif;
        font-size: 25px;
        color: black;
      }
      .round-competitors-card {
        font-family: "Jost", Arial, Helvetica, sans-serif;
        font-size: 15px;
        color: #888;
      }
      .listitem {
        cursor: pointer;
        padding: 10px 20px;
        margin-bottom: 15px;
        transition: 300ms;
      }
      .listitem:hover {
        color: white !important;
        background-color: #9e1c43;
      }
      .listitem:hover > .round-name-card, .listitem:hover > .round-competitors-card {
        color: white;
      }

      #logocontainer > #dragon {
        height: 30px;
        display: inline-block;
      }
      #logocontainer > h1 {
        font-family: "Jost Medium", Futura, Helvetica, Arial, sans-serif;
        text-transform: uppercase;
        font-size: 20px;
        color: #9e1c43;
        text-align: center;
      }
      #scores-container > .card {
        margin: 20px;
        height: 230px;
        width: 230px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: 400ms;
      }
    </style>
  </head>
  <body>

    <div id="wrapper">
      <div id="home-box">
        <img src="../../dragon.svg" id="dragon">
        <h1>CHS Math Bowl</h1>
        <h4 ondblclick="signOut()"></h4>
        <div id="matches-list">
          Loading matches...
        </div>
      </div>
    </div>

    <script src="/__/firebase/7.5.0/firebase-app.js"></script>
    <script src="/__/firebase/7.5.0/firebase-auth.js"></script>
    <script src="/__/firebase/7.5.0/firebase-database.js"></script>
    <script src="/__/firebase/init.js"></script>
    <script>

      function signOut() {
        firebase.auth().signOut().then(function() {
          window.location = "../login.html";
        }).catch(function(error) {});
      }

      let _user = null;
      let localRounds = {};
      let localMatches = {};
      let localTeams = {};

      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          if(user.email === "admin.mathbowl@brandongong.org") {
            window.location = "../admin-console/index.html";
          } else {
            _user = user.email.split("\.")[0];

            firebase.database().ref("/rooms/"+_user).on('value', (snap) => {
              let rn = snap.val()["number"], ih = "";
              if(rn.toLowerCase().includes("room")) ih = rn;
              else ih = "Room " + rn;
              document.getElementsByTagName("h4")[0].innerHTML = ih;
            });
            firebase.database().ref("/rounds").on('value', (snap) => {localRounds = snap.val()});
            firebase.database().ref("/matches").on('value', (snap) => {
              localMatches = snap.val();
              localMatches = Object.fromEntries(Object.entries(localMatches).filter(([k,v]) => (v[_user] && v[_user]["status"] !== 2)));
              regenMatchCards();
            });
          }
        } else {
          window.location = "../login.html";
        }
      });

      function regenMatchCards() {
        firebase.database().ref("/teams/abbrev").once('value').then((snap) => {
          localTeams = snap.val();
          let ih = "";
          for(let i of Object.keys(localMatches)) {
            ih += `
              <div class="card listitem" onclick="renderMatch('${i}')">
                <div class="round-name-card">${localRounds[i]["name"]}</div>
                <div class="round-competitors-card">${localTeams[localMatches[i][_user]["t1"]]} vs. ${localTeams[localMatches[i][_user]["t2"]]}</div>
              </div>
            `;
          }
          ih += `
              <div class="card listitem" onclick="renderMatch('special')">
                <div class="round-name-card">Create special round</div>
                <div class="round-competitors-card">(Run custom match not in queue)</div>
              </div>
            `;
          document.getElementById("matches-list").innerHTML = ih;
        });
      }

      function renderMatch(roundID) {
        let pre = window.location.href;
        let iom = pre.match("index\.html").index;
        if(iom) window.location.href = pre.substring(0, iom)+"in_game.html?roundID="+roundID;
      }

    </script>
  </body>
</html>
